<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Options Payoff Simulator</title>
  <style>
    :root{
      --strike-color: #2e7d32;
      --premium-color: #9c27b0;
      --stock-color: #2196f3;
      --line-default: #1a237e;
      --canvas-bg: #ffffff;
      --call-color: #1976d2;
      --put-color: #d32f2f;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      background: var(--canvas-bg);
      padding: 18px;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      color: #111;
      display:flex;
      justify-content:center;
    }
    .container {
      width:1100px; max-width:100%;
      background:#fff; border-radius:10px;
      box-shadow:0 10px 30px rgba(0,0,0,0.08); overflow:hidden;
    }
    header { padding:16px 20px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:12px; }
    .header-left { display:flex; flex-direction:column; gap:4px; }
    h1 { font-size:18px; color:#222; margin-bottom:4px; }
    .subtitle { color:#666; font-size:13px; }
    .nav-btn { padding:8px 16px; background:#1976d2; color:white; border:none; border-radius:6px; cursor:pointer; font-weight:600; text-decoration:none; font-size:13px; transition: background 0.2s; }
    .nav-btn:hover { background:#1565c0; }

    .controls { display:flex; gap:12px; align-items:center; padding:12px 18px; background:#fbfdff; border-bottom:1px solid #eee; flex-wrap:wrap; }
    .control { display:flex; flex-direction:column; gap:6px; padding:6px 8px; border-radius:8px; border:1px solid #e6eef8; min-width:180px; background:#fff; }
    .swatch { width:14px; height:14px; border-radius:3px; display:inline-block; margin-right:8px; }
    .fixed-display { font-size:14px; font-weight:700; padding:6px 8px; background:#fafafa; border-radius:6px; color:#111; border:1px solid #eee; }
    
    .option-selector { margin-bottom: 12px; }
    .option-type-buttons { display: flex; gap: 8px; margin-top: 8px; }
    .option-type-btn { padding: 8px 16px; border: 2px solid #ddd; border-radius: 6px; background: white; cursor: pointer; font-weight: 600; transition: all 0.2s; }
    .option-type-btn.active { background: #2196f3; color: white; border-color: #2196f3; }
    .option-type-btn:hover { border-color: #2196f3; }

    .main { display:flex; gap:0; }
    .chart-column { flex:1 1 auto; min-height:560px; display:flex; flex-direction:column; }
    .canvas-container { padding:16px; background:var(--canvas-bg); height:560px; display:flex; align-items:center; justify-content:center; position:relative; }
    canvas { border:2px solid #ddd; border-radius:8px; background:var(--canvas-bg); width:100%; height:100%; display:block; }

    .legend { padding:10px 20px; display:flex; gap:18px; align-items:center; justify-content:center; border-top:1px solid #eee; background:#fff; }
    .legend-item { display:flex; align-items:center; gap:8px; font-size:13px; color:#333; }

    .results { padding:12px 20px 20px 20px; background:#fff; border-top:1px solid #eee; font-size:13px; }
    .result-row { display:flex; justify-content:space-between; padding:8px 0; }
    .result-label { font-weight:600; color:#333; }
    .result-value { font-weight:700; color:#2b6cb0; }

    .disclaimer { padding:16px 20px; background:#f8f9fa; border-top:1px solid #eee; font-size:11px; color:#666; text-align:center; line-height:1.5; }

    @media (max-width:900px) { .container { width:100%; } .canvas-container { height:420px; } }
  </style>
</head>
<body>
  <div class="container" role="main">
    <header>
      <div class="header-left">
        <h1>Options Payoff Simulator</h1>
        <div class="subtitle">Interactive visualizer for learning call and put option payoffs.</div>
      </div>
      <a href="strategies.html" target="_blank" class="nav-btn">ðŸ“ˆ Options Strategies â†’</a>
    </header>

    <div class="controls" aria-label="Controls">      <div class="control option-selector">
        <div>Option Type</div>
        <div class="option-type-buttons">
          <button id="longCallBtn" class="option-type-btn active">Long Call</button>
          <button id="longPutBtn" class="option-type-btn">Long Put</button>
          <button id="shortCallBtn" class="option-type-btn">Short Call</button>
          <button id="shortPutBtn" class="option-type-btn">Short Put</button>
        </div>
      </div>

      <div class="control">
        <div><span class="swatch" style="background:var(--strike-color)"></span> Strike price K = $80</div>
        <div class="fixed-display" style="color:var(--strike-color)">K = $80</div>
      </div>

      <div class="control">
        <div><span class="swatch" style="background:var(--premium-color)"></span> <span id="premiumLabel">Call premium (C)</span></div>
        <div class="fixed-display" style="color:var(--premium-color)" id="premiumDisplay">- $3.00</div>
      </div>

      <div class="control">
        <div><span class="swatch" style="background:var(--stock-color)"></span> Stock price at maturity S<sub>T</sub></div>
        <div style="display:flex;justify-content:space-between">
          <div style="font-size:12px;color:#666">Range: $60 â€” $150</div>
          <div id="stockVal" style="font-weight:700;color:var(--stock-color)">$88</div>
        </div>
        <input id="stockSlider" type="range" min="60" max="150" step="1" value="88" style="margin-top:8px" />
        <div style="font-size:12px;color:#666;margin-top:4px">Initial price S<sub>0</sub> = $80</div>
      </div>
    </div>

    <div class="main">
      <div class="chart-column">
        <div class="canvas-container">
          <canvas id="payoffChart" aria-label="Options payoff chart"></canvas>
        </div>

        <div class="legend">
          <div class="legend-item"><div style="width:36px;height:4px;background:var(--strike-color)"></div> Strike (K)</div>
          <div class="legend-item"><div style="width:36px;height:4px;background:var(--premium-color)"></div> Premium</div>
          <div class="legend-item"><div style="width:36px;height:4px;background:var(--stock-color)"></div> S<sub>T</sub></div>
        </div>

        <div class="results">
          <div class="result-row"><div class="result-label">Option Type</div><div class="result-value" id="resultOptionType">Call</div></div>
          <div class="result-row"><div class="result-label">Initial Stock Price (S<sub>0</sub>)</div><div class="result-value">$80.00</div></div>
          <div class="result-row"><div class="result-label">Strike Price (K)</div><div class="result-value" id="resultStrike">$80.00</div></div>
          <div class="result-row"><div class="result-label">Stock Price (S<sub>T</sub>)</div><div class="result-value" id="resultStockPrice">$88.00</div></div>
          <div class="result-row"><div class="result-label" id="resultPremiumLabel">Call Premium (cost)</div><div class="result-value" id="resultPremium">-$3.00</div></div>
          <div class="result-row"><div class="result-label">Intrinsic Value <span id="intrinsicFormula" style="font-size:11px;color:#666;">[max(S<sub>T</sub>-K,0)]</span></div><div class="result-value" id="resultPayoff">$8.00</div></div>
          <div class="result-row"><div class="result-label">Time Value <span style="font-size:11px;color:#666;">[Premium - Intrinsic]</span></div><div class="result-value" id="resultTimeValue">$0.00</div></div>
          <div class="result-row"><div class="result-label">Net Profit / Loss</div><div class="result-value" id="resultNetPL">$5.00</div></div>
          <div class="result-row"><div class="result-label">Breakeven</div><div class="result-value" id="resultBreakeven">$83.00</div></div>
        </div>
      </div>
    </div>
    
    <div class="disclaimer">
      <strong>Disclaimer:</strong> This information is for educational purposes only and should not be considered financial advice. Options trading involves risk, and you should consult with a financial professional before making any investment decisions.
    </div>
  </div>

  <script>    const FIXED_K = 80;
    const FIXED_CALL_C = 3;
    const FIXED_PUT_C = 3;
    const INITIAL_STOCK_PRICE = 80; // Sâ‚€ - stock price when option was purchased
    const canvas = document.getElementById('payoffChart');
    const ctx = canvas.getContext('2d');
    const stockSlider = document.getElementById('stockSlider');
    const stockVal = document.getElementById('stockVal');
    const longCallBtn = document.getElementById('longCallBtn');
    const longPutBtn = document.getElementById('longPutBtn');
    const shortCallBtn = document.getElementById('shortCallBtn');
    const shortPutBtn = document.getElementById('shortPutBtn');
    const premiumLabel = document.getElementById('premiumLabel');
    const premiumDisplay = document.getElementById('premiumDisplay');
    const rOptionType = document.getElementById('resultOptionType');
    const rStrike = document.getElementById('resultStrike');
    const rStock = document.getElementById('resultStockPrice');
    const rPremium = document.getElementById('resultPremium');
    const rPremiumLabel = document.getElementById('resultPremiumLabel');
    const rPayoff = document.getElementById('resultPayoff');
    const rTimeValue = document.getElementById('resultTimeValue');
    const rNet = document.getElementById('resultNetPL');
    const rBE = document.getElementById('resultBreakeven');
    const intrinsicFormula = document.getElementById('intrinsicFormula');

    let K = FIXED_K, ST = Number(stockSlider.value);
    let isCall = true;
    let isShort = false;

    function getCurrentPremium() {
      return isCall ? FIXED_CALL_C : FIXED_PUT_C;
    }

    function calculateIntrinsic(ST, K, isCall) {
      return isCall ? Math.max(ST - K, 0) : Math.max(K - ST, 0);
    }

    function calculateBreakeven(K, premium, isCall) {
      return isCall ? K + premium : K - premium;
    }

    function ensureCanvasSize(canvas) {
      const dpr = window.devicePixelRatio || 1;
      const rect = canvas.getBoundingClientRect();
      const cssW = Math.max(300, Math.round(rect.width));
      const cssH = Math.max(150, Math.round(rect.height));
      const targetW = Math.round(cssW * dpr);
      const targetH = Math.round(cssH * dpr);
      if (canvas.width !== targetW || canvas.height !== targetH) {
        canvas.width = targetW;
        canvas.height = targetH;
        ctx.setTransform(dpr,0,0,dpr,0,0);
      }
    }    function updateLabels() {
      const positionType = isShort ? 'Short' : 'Long';
      const optionType = isCall ? 'Call' : 'Put';
      const premium = getCurrentPremium();
      
      premiumLabel.textContent = `${positionType} ${optionType} premium (${isCall ? 'C' : 'P'})`;
      premiumDisplay.textContent = `${isShort ? '+ ' : '- '}$${premium.toFixed(2)}`;
      rOptionType.textContent = `${positionType} ${optionType}`;
      rPremiumLabel.textContent = `${positionType} ${optionType} Premium (${isShort ? 'received' : 'cost'})`;
      
      // Update intrinsic value formula based on option type
      if (isCall) {
        intrinsicFormula.innerHTML = '[max(S<sub>T</sub>-K,0)]';
      } else {
        intrinsicFormula.innerHTML = '[max(K-S<sub>T</sub>,0)]';
      }
    }    function calculateAndDraw() {
      ST = Number(stockSlider.value);
      const C = getCurrentPremium();
      const intrinsic = calculateIntrinsic(ST, K, isCall);
      
      // At expiration, time value is 0 (all time value has decayed)
      // But we can show what the time value was when purchased
      // Time Value = Premium - Intrinsic Value at purchase
      const intrinsicAtPurchase = calculateIntrinsic(INITIAL_STOCK_PRICE, K, isCall);
      const timeValueAtPurchase = C - intrinsicAtPurchase;
      
      // For short positions, the P&L is inverted
      const netPL = isShort ? C - intrinsic : intrinsic - C;
      const BE = calculateBreakeven(K, C, isCall);

      rStrike.textContent = `$${K.toFixed(2)}`;
      rStock.textContent = `$${ST.toFixed(2)}`;
      rPremium.textContent = `${isShort ? '+' : '-'}$${C.toFixed(2)}`;
      rPayoff.textContent = `$${intrinsic.toFixed(2)}`;
      rTimeValue.textContent = `$${timeValueAtPurchase.toFixed(2)}`;
      rNet.textContent = `${netPL>=0?'+':''}$${netPL.toFixed(2)}`;
      rBE.textContent = `$${BE.toFixed(2)}`;
      draw(K, C, ST, netPL, BE, isCall, isShort);
    }    function draw(K, C, ST, netPL, BE, isCall, isShort) {
      ensureCanvasSize(canvas);
      const cssW = canvas.width / (window.devicePixelRatio || 1);
      const cssH = canvas.height / (window.devicePixelRatio || 1);
      ctx.clearRect(0,0,cssW,cssH);
      ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--canvas-bg') || '#fff';
      ctx.fillRect(0,0,cssW,cssH);

      const margin = 60;
      const plotW = cssW - margin*2;
      const plotH = cssH - margin*2;

      // Use fixed price range so strike and breakeven don't appear to move
      const minPrice = 50;  // Fixed minimum price
      const maxPrice = 160; // Fixed maximum price  
      const priceRange = maxPrice - minPrice;
      
      // Adjust profit range for puts and short positions (they can make more profit when stock goes down)
      const maxCallProfit = isShort ? C : maxPrice - K - C;
      const maxPutProfit = isShort ? C : K - minPrice - C;
      const maxProfit = Math.max(maxCallProfit, maxPutProfit, 10);
      const minLoss = isShort ? -(maxPrice - K - C) : -Math.max(C*1.5, 8);
      const profitRange = Math.max(1e-6, maxProfit - minLoss);

      const priceToX = p => margin + ((p - minPrice) / priceRange) * plotW;
      const profitToY = v => margin + (1 - ((v - minLoss) / profitRange)) * plotH;

      // grid
      ctx.save();
      ctx.strokeStyle = '#e6eef8';
      ctx.lineWidth = 1;
      ctx.setLineDash([3,4]);
      for (let i=0;i<=4;i++){
        const px = priceToX(minPrice + (priceRange * i / 4));
        ctx.beginPath(); ctx.moveTo(px,margin); ctx.lineTo(px, margin+plotH); ctx.stroke();
      }
      for (let i=0;i<=4;i++){
        const py = profitToY(minLoss + (profitRange * i / 4));
        ctx.beginPath(); ctx.moveTo(margin, py); ctx.lineTo(margin+plotW, py); ctx.stroke();
      }
      ctx.setLineDash([]);
      ctx.restore();

      // axes - changed to black color
      ctx.strokeStyle = '#000000'; ctx.lineWidth = 3;
      ctx.beginPath(); ctx.moveTo(margin, profitToY(0)); ctx.lineTo(margin+plotW, profitToY(0)); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(margin, margin); ctx.lineTo(margin, margin+plotH); ctx.stroke();

      // payoff line - inverted for short positions
      const optionColor = isCall ? '#1976d2' : '#d32f2f';
      ctx.strokeStyle = optionColor; ctx.lineWidth = 4;
      ctx.beginPath();
      
      const steps = 120;
      for (let i=0;i<=steps;i++){
        const p = minPrice + (i/steps)*(maxPrice-minPrice);
        let prof;
        if (isShort) {
          if (isCall) {
            prof = C - Math.max(0, p-K);
          } else {
            prof = C - Math.max(0, K-p);
          }
        } else {
          if (isCall) {
            prof = Math.max(0, p-K) - C;
          } else {
            prof = Math.max(0, K-p) - C;
          }
        }
        if (i===0) ctx.moveTo(priceToX(p), profitToY(prof)); 
        else ctx.lineTo(priceToX(p), profitToY(prof));
      }
      ctx.stroke();

      // overlay green portion for profitable region
      const profitColor = getComputedStyle(document.documentElement).getPropertyValue('--strike-color') || '#2e7d32';
      ctx.strokeStyle = profitColor; ctx.lineWidth = 4;
      ctx.beginPath();
      
      let profitStart = false;
      for (let i=0;i<=steps;i++){
        const p = minPrice + (i/steps)*(maxPrice-minPrice);
        let prof;
        if (isShort) {
          if (isCall) {
            prof = C - Math.max(0, p-K);
          } else {
            prof = C - Math.max(0, K-p);
          }
        } else {
          if (isCall) {
            prof = Math.max(0, p-K) - C;
          } else {
            prof = Math.max(0, K-p) - C;
          }
        }
        
        if (prof > 0) {
          if (!profitStart) {
            ctx.moveTo(priceToX(p), profitToY(prof));
            profitStart = true;
          } else {
            ctx.lineTo(priceToX(p), profitToY(prof));
          }
        } else {
          profitStart = false;
        }
      }
      ctx.stroke();

      // strike vertical line
      ctx.setLineDash([6,6]); 
      ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--strike-color') || '#2e7d32'; 
      ctx.lineWidth = 2;
      ctx.beginPath(); 
      ctx.moveTo(priceToX(K), margin); 
      ctx.lineTo(priceToX(K), margin+plotH); 
      ctx.stroke();
      ctx.setLineDash([]);

      // breakeven line
      ctx.setLineDash([6,6]); 
      ctx.strokeStyle = '#ff9800'; 
      ctx.beginPath(); 
      ctx.moveTo(priceToX(BE), margin); 
      ctx.lineTo(priceToX(BE), margin+plotH); 
      ctx.stroke(); 
      ctx.setLineDash([]);

      // ST references
      ctx.setLineDash([8,6]); 
      ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--stock-color') || '#2196f3'; 
      ctx.lineWidth = 2;
      ctx.beginPath(); 
      ctx.moveTo(margin, profitToY(netPL)); 
      ctx.lineTo(priceToX(ST), profitToY(netPL)); 
      ctx.stroke();
      ctx.beginPath(); 
      ctx.moveTo(priceToX(ST), profitToY(netPL)); 
      ctx.lineTo(priceToX(ST), margin+plotH); 
      ctx.stroke(); 
      ctx.setLineDash([]);

      // dot color based on profit/loss
      let dotColor = '#ff9800';
      if (isShort) {
        if (isCall && ST > K) dotColor = '#f44336';
        else if (!isCall && ST < K) dotColor = '#f44336';
        else if (netPL >= 0) dotColor = profitColor;
      } else {
        if (isCall && ST < K) dotColor = '#f44336';
        else if (!isCall && ST > K) dotColor = '#f44336';
        else if (netPL >= 0) dotColor = profitColor;
      }
      
      ctx.fillStyle = dotColor; ctx.strokeStyle = '#222'; ctx.lineWidth = 1;
      ctx.beginPath(); ctx.arc(priceToX(ST), profitToY(netPL), 8, 0, Math.PI*2); ctx.fill(); ctx.stroke();

      // Dynamic ITM/OTM/ATM label that moves with the dot
      // ITM/OTM is based on intrinsic value, not profitability
      let moneyStatus = '';
      if (ST === K) {
        moneyStatus = 'At The Money (ATM)';
      } else if (isCall && ST > K) {
        moneyStatus = 'In The Money (ITM)';
      } else if (isCall && ST < K) {
        moneyStatus = 'Out of Money (OTM)';
      } else if (!isCall && ST < K) {
        moneyStatus = 'In The Money (ITM)';
      } else if (!isCall && ST > K) {
        moneyStatus = 'Out of Money (OTM)';
      }
      
      // Position the label above the dot, but ensure it stays within canvas bounds
      const labelY = Math.max(profitToY(netPL) - 15, 30);
      const labelX = priceToX(ST);
      
      ctx.fillStyle = '#fff';
      ctx.strokeStyle = '#333';
      ctx.lineWidth = 1;
      ctx.font = 'bold 12px Arial';
      const textWidth = ctx.measureText(moneyStatus).width;
      const textHeight = 16;
      const padding = 4;
      
      // Adjust label position if it would go off screen
      let adjustedLabelX = labelX - textWidth/2;
      if (adjustedLabelX < margin) adjustedLabelX = margin;
      if (adjustedLabelX + textWidth > margin + plotW) adjustedLabelX = margin + plotW - textWidth;
      
      // Draw label background
      ctx.beginPath();
      // Use simple rect if roundRect is not available
      if (ctx.roundRect) {
        ctx.roundRect(adjustedLabelX - padding, labelY - textHeight, textWidth + padding*2, textHeight + padding, 3);
      } else {
        ctx.rect(adjustedLabelX - padding, labelY - textHeight, textWidth + padding*2, textHeight + padding);
      }
      ctx.fill();
      ctx.stroke();
      
      // Draw label text
      ctx.fillStyle = '#333';
      ctx.textAlign = 'left';
      ctx.fillText(moneyStatus, adjustedLabelX, labelY - 4);

      // labels
      ctx.fillStyle = '#111'; ctx.font = 'bold 18px Arial'; ctx.textAlign = 'center';
      ctx.fillText(`${isShort ? 'Short' : 'Long'} ${isCall ? 'Call' : 'Put'} Option - Strike K = ${K.toFixed(0)}`, Math.round(cssW/2), 28);

      // small ticks and labels
      ctx.fillStyle = '#000'; ctx.font = 'bold 14px Arial'; ctx.textAlign = 'right';
      ctx.fillText('$0', margin-10, profitToY(0)+5);
      ctx.fillStyle = netPL>=0? '#4caf50' : '#f44336';
      ctx.fillText((netPL>=0?'+':'') + `$${netPL.toFixed(0)}`, margin-10, profitToY(netPL)+5);
      
      // Show premium on chart (received for short, cost for long)
      ctx.fillStyle = '#9c27b0'; ctx.font = 'bold 12px Arial'; ctx.textAlign = 'right';
      if (isShort) {
        ctx.fillText(`+$${C.toFixed(0)}`, margin-10, profitToY(C)+5);
      } else {
        ctx.fillText(`-$${C.toFixed(0)}`, margin-10, profitToY(-C)+5);
      }
      
      // Add Y-axis label
      ctx.save();
      ctx.translate(20, margin + plotH/2);
      ctx.rotate(-Math.PI/2);
      ctx.fillStyle = '#333'; ctx.font = 'bold 16px Arial'; ctx.textAlign = 'center';
      ctx.fillText('Payoff ($)', 0, 0);
      ctx.restore();

      // baseline labels - improved spacing to prevent overlap
      ctx.font = 'bold 16px Arial'; ctx.textAlign = 'center';
      ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--strike-color') || '#2e7d32'; 
      ctx.fillText(`K=${K.toFixed(0)}`, priceToX(K), margin+plotH+28);
      
      // Position breakeven label to avoid overlap with strike label
      ctx.fillStyle = '#ff9800'; 
      const beXPos = priceToX(BE);
      const kXPos = priceToX(K);
      let beYOffset = 28;
      
      // If breakeven is too close to strike, offset the label vertically
      if (Math.abs(beXPos - kXPos) < 40) {
        beYOffset = 44; // Move breakeven label down
      }
      
      ctx.fillText(`BE=${BE.toFixed(0)}`, beXPos, margin+plotH+beYOffset);
      
      ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--stock-color') || '#2196f3'; 
      ctx.font = 'bold 18px Arial'; 
      ctx.fillText(`${ST.toFixed(0)}`, priceToX(ST), margin+plotH+52);

      // Add X-axis label
      ctx.fillStyle = '#333'; ctx.font = 'bold 16px Arial'; ctx.textAlign = 'center';
      ctx.fillText('Stock Price at Expiration (S', margin + plotW/2 - 10, margin+plotH+75);
      
      // Add subscript T for ST
      ctx.font = 'bold 12px Arial';
      ctx.fillText('T', margin + plotW/2 + 45, margin+plotH+78);
      
      // Continue with closing parenthesis and dollar sign
      ctx.font = 'bold 16px Arial';
      ctx.fillText(') ($)', margin + plotW/2 + 55, margin+plotH+75);

      ctx.fillStyle = '#666'; ctx.font = '14px Arial'; ctx.textAlign = 'center';
      ctx.fillText('Options Payoff Diagram', Math.round(cssW/2), Math.round(cssH)-8);
    }    function switchToLongCall() {
      isCall = true;
      isShort = false;
      longCallBtn.classList.add('active');
      longPutBtn.classList.remove('active');
      shortCallBtn.classList.remove('active');
      shortPutBtn.classList.remove('active');
      updateLabels();
      calculateAndDraw();
    }

    function switchToLongPut() {
      isCall = false;
      isShort = false;
      longPutBtn.classList.add('active');
      longCallBtn.classList.remove('active');
      shortCallBtn.classList.remove('active');
      shortPutBtn.classList.remove('active');
      updateLabels();
      calculateAndDraw();
    }

    function switchToShortCall() {
      isCall = true;
      isShort = true;
      shortCallBtn.classList.add('active');
      longCallBtn.classList.remove('active');
      longPutBtn.classList.remove('active');
      shortPutBtn.classList.remove('active');
      updateLabels();
      calculateAndDraw();
    }

    function switchToShortPut() {
      isCall = false;
      isShort = true;
      shortPutBtn.classList.add('active');
      longCallBtn.classList.remove('active');
      longPutBtn.classList.remove('active');
      shortCallBtn.classList.remove('active');
      updateLabels();
      calculateAndDraw();
    }

    // init
    function init(){
      ensureCanvasBitmapSize(canvas);
      updateLabels();
      calculateAndDraw();
    }
    function ensureCanvasBitmapSize(c){ const dpr=window.devicePixelRatio||1; const rect=c.getBoundingClientRect(); const cssW=Math.round(rect.width)||300; const cssH=Math.round(rect.height)||150; const tW=Math.round(cssW*dpr); const tH=Math.round(cssH*dpr); if(c.width!==tW||c.height!==tH){ c.width=tW; c.height=tH; ctx.setTransform(dpr,0,0,dpr,0,0); } }
      // Event listeners
    stockSlider.addEventListener('input',()=>{ ST=Number(stockSlider.value); stockVal.textContent=`$${ST}`; calculateAndDraw(); });
    longCallBtn.addEventListener('click', switchToLongCall);
    longPutBtn.addEventListener('click', switchToLongPut);
    shortCallBtn.addEventListener('click', switchToShortCall);
    shortPutBtn.addEventListener('click', switchToShortPut);
    
    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init); else init();
  </script>
</body>
</html>